<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>黑暗之门</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="static/command/bootstrap.min.css">
    <link rel="stylesheet" href="static/command/bootstrap-theme.min.css">
    <link rel="stylesheet" href="static/css/font-awesome.min.css">
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="shortcut icon" href="static/favicon.ico" type="image/x-icon">
</head>

<body>

    <aside class="left-panel">
        <!-- Static navbar -->
        <nav class="navbar navbar-static-top navbar-inverse">
            <div class="navbar-header">
                <span class="navbar-brand brand-title">黑暗之门<span class="blinking-cursor">&#x25ae;</span></span>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">常用命令集 <span class="caret"></span></a>
                        <ul id="listCommandSet" class="dropdown-menu">
                            <!-- ?php require_once('listCommandSet.php'); ?-->
                        </ul>
                    </li>
                </ul>

                <button id="addCommand" class="btn btn-success navbar-btn">添加 <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span></button>
                <button id="deleteCommand" class="btn btn-danger navbar-btn">删除 <span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>
                <ul class="nav navbar-nav navbar-right">
                    <div class="navbar-form navbar-left">
                        <form id="runCommandForm" class="form-group">
                            {{if .defaultPath}}
                            <label class="navbar-text">执行目录：</label>
                            <input id="path" name="path" type="text" class="form-control input-sm" size="20" value="{{.defaultPath}}"> {{end}}
                            <span>.  .</span>
                            <b>
                            <input id="command" name="command" type="text" size="60" class="form-control" placeholder="请在这里输入Shell命令来运行">
                        </b>
                            <input id="html" name="html" value="1" hidden="true">
                            <!-- div class="checkbox navbar-btn">
                            <label class="navbar-link">
                                <input type="checkbox" name="oneTimeCommandIsDynamic">
                                    <a class="tooltips" href="#">Dynamic/Interactive
                                    <span>Check this for:<br>1. Commands requiring dynamic updates (<i>ex: tail, top</i>)<br>2. Commands requiring interaction (<i>ex: vi, bash, ssh</i>)</span>
                                    </a>
                            </label>
                        </div -->
                            <button id="runCommand" class="btn btn-primary">执行 <span class="glyphicon glyphicon-play-circle" aria-hidden="true"></span></button>
                        </form>
                    </div>
                </ul>

            </div>
            <!--/.nav-collapse -->
        </nav>
    </aside>
    <!-- Aside Ends-->

    <!-- Add command form -->
    <div id="overlayBackground" class="overlay-back"></div>
    <div id="overlayMain" class="overlay-div">
        <a href="#"><span onclick="$('#overlayMain, #overlayBackground').fadeOut()" style="font-size: 1.5em;" class="fa fa-close pull-right"></span></a>
        <div class="panel panel-default">
            <div class="panel-heading" style="text-align: center">
                <span class="panel-title"><strong>请输入要添加的命令</strong></span>
            </div>
            <!-- End of panel heading -->
            <form id="addCommandForm" style="padding: 5px">
                <div id="inputgroup1" class="input-group">
                    <span class="input-group-addon"><span class="glyphicon glyphicon-console" aria-hidden="true"></span></span>
                    <input id="command" name="command" type="text" maxlength="255" class="form-control" placeholder="这里输入shell命令" autocomplete="off" autofocus>
                </div>
                <div id="commandFeedback" class="text-center feedback"></div>
                <br>
                <div id="inputgroup2" class="input-group">
                    <span class="input-group-addon"><span class="fa fa-tags" aria-hidden="true"></span></span>
                    <input id="label" name="label" type="text" maxlength="30" placeholder="请在这里输入一个标签" autocomplete="off" class="form-control">
                </div>
                <div id="labelFeedback" class="text-center feedback"></div>
                <br>
                <div style="text-align: center">
                    <input type="checkbox" id="isDynamic" name="isDynamic">
                    <a class="tooltips" href="#">Dynamic/Interactive
                        <span>Check this for:<br>1. Commands requiring dynamic updates (<i>ex: tail, top</i>)<br>2. Commands requiring interaction (<i>ex: vi, bash, ssh</i>)</span>
                    </a>
                    <div id="isDynamicFeedback" class="text-center feedback"></div>
                </div>
                <br>
                <div class="text-center"><button id="submit" type="button" class="btn btn-sm btn-primary">保存 <span class="glyphicon glyphicon-save" aria-hidden="true"></span></button></div>
            </form>
        </div>
        <!-- End of panel -->
    </div>
    <!-- End of overlay -->

    <div id="terminal" class="maindiv">
        <div class="img-container">
            <img src="static/img/terminal.png">
        </div>
    </div>

    <!-- All javascript scripts -->
    <script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {

            // Initially disable the delete button
            $('#deleteCommand').prop('disabled', true);

            //----------------------------------------------------------------
            // Add Command Form submission validation, performs some checks on the user input
            $("#submit").click(function(e) {
                // Prevent default form behaviour
                e.preventDefault();

                // Get form parameters attributes and perform basic checks, even if all these will be checked server side as well
                var command = $("#command").val();
                var label = $("#label").val();
                var error = false;

                if (command === '') {
                    error = true;
                    $("#inputgroup1").addClass("has-error");
                    $("#commandFeedback").show();
                    $("#commandFeedback").html("Command is empty");
                }

                if (label === '') {
                    error = true;
                    $("#inputgroup2").addClass("has-error");
                    $("#labelFeedback").show();
                    $("#labelFeedback").html("Label is empty");
                }

                if (!error) {
                    $.ajax({
                        url: "addCommand.php",
                        type: "POST",
                        data: $("#addCommandForm").serialize(),
                        success: function(data) {
                            if (data === 'success') {
                                // If the command is successful, refresh the command set dropdown list
                                $('#listCommandSet').load("listCommandSet.php");
                            }
                        },
                        dataType: 'text'
                    });

                    $('#overlayMain, #overlayBackground').fadeOut();
                }
            });

            //----------------------------------------------------------------
            // Function to show the "Add command" form as well as fade out the background
            $('#addCommand').click(function() {
                $('#overlayMain, #overlayBackground').fadeIn();
            });

            //----------------------------------------------------------------
            // Function to call the run a "one time" command
            $('#runCommand').click(function(e) {
                // Prevent default form behaviour
                e.preventDefault();

                // Show a waiting message
                $('#terminal').html('Proceeding with you request...');

                // Get form parameters attributes and perform basic checks, even if all these will be checked server side as well
                var command = $("#command").val();
                if (command === '') {
                    alert("请输入命令后再执行...");
                    exit();
                }

                $.ajax({
                    url: "command",
                    type: "POST",
                    data: $("#runCommandForm").serialize(),
                    success: function(data) {
                        // If the command is successful, update the terminal div
                        $('#terminal').html(data);
                    },
                    dataType: 'html'
                });
            });

            //----------------------------------------------------------------
            // Use the JQuery 'on" method for dynamically generated HTML elements
            $('#listCommandSet').on('click', 'a[data-command-id]', function() {
                // Show a waiting message
                $('#terminal').html('Proceeding with you request...');
                var commandID = $(this).attr("data-command-id");

                $('#deleteCommand').attr('data-delete-id', commandID);
                $('#deleteCommand').prop('disabled', false);

                // Change window title to the command to run
                window.document.title = $(this).text();

                $.ajax({
                    url: "runCommand.php?commandID=" + commandID,
                    type: "GET",
                    success: function(data) {
                        // If the command is successful, update the terminal div
                        $('#terminal').html(data);
                    },
                    dataType: 'html'
                });
            });

            //----------------------------------------------------------------
            // Delete a command from the set
            $('#deleteCommand').click(function() {
                var commandID = $(this).attr("data-delete-id");
                var label = $('a[data-command-id=' + commandID + ']').text();

                if (confirm("Delete command " + label + "\nAre you SURE ?")) {
                    $.ajax({
                        url: "deleteCommand.php?commandID=" + commandID,
                        type: "GET",
                        success: function(data) {
                            if (data === 'success') {
                                // If the command is successful, refresh the command set dropdown list
                                $('#listCommandSet').load("listCommandSet.php");

                                // Disable the delete button
                                $('#deleteCommand').attr('data-delete-id', 'none');
                                $('#deleteCommand').prop('disabled', true);

                            }
                        },
                        dataType: 'text'
                    });
                }
            });
        });
    </script>
</body>

</html>